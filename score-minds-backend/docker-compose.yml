version: '3.8'

services:
  # ---------------------------------------------
  # 1. BAZA PODATAKA (PostgreSQL)
  # ---------------------------------------------
  postgres-db:
    image: postgres:15-alpine
    container_name: scoreminds_db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: nikola1234
      POSTGRES_DB: ScoreMinds
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ScoreMinds"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------
  # 2. MESSAGE BROKER (RabbitMQ) - NOVO!
  # ---------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: scoreminds_rabbitmq
    restart: always
    ports:
      - "5672:5672"   # Port za komunikaciju (NestJS se ka캜i ovde)
      - "15672:15672" # Management UI (ulazi코 preko browsera)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # ---------------------------------------------
  # 3. BACKEND API (NestJS u Dev Modu)
  # ---------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: build  # 游녣 OVO JE KLJU캛NO: Koristimo prvu fazu Dockerfile-a gde su svi alati
    container_name: scoreminds_api
    restart: always
    
    # Ovde mapiramo portove (3000 za API, dodajemo i WebSocket port ako je razli캜it)
    ports:
      - "3000:3000"
    
    # "depends_on" osigurava da se API ne pali pre baze i rabbita
    depends_on:
      postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_started

    # Varijable koje NestJS 캜ita (ConfigService)
    environment:
      # Baza
      DB_HOST: postgres-db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: nikola1234
      DB_NAME: ScoreMinds
      
      # Server
      PORT: 3000
      
      # RabbitMQ (URL format: amqp://user:pass@host:port)
      RABBITMQ_URI: amqp://guest:guest@rabbitmq:5672
      
      # Ostalo
      JWT_SECRET: tvoj_super_tajni_kljuc_123

    # Volumeni za "Hot Reload" (da ne mora코 da restartuje코 kontejner kad menja코 kod)
    volumes:
      - .:/app               # Mapira tvoj lokalni folder u kontejner
      - /app/node_modules    # 캛uva node_modules unutar kontejnera netaknutim

    # Komanda koja pokre캖e dev server
    command: npm run start:dev

    # ---------------------------------------------
  # 4. FRONTEND (Angular)
  # ---------------------------------------------
  frontend:
    build:
      context: ../score-minds-frontend  # 游녣 Ovde stavi ta캜no ime foldera gde ti je Angular
      dockerfile: Dockerfile
    container_name: scoreminds_frontend
    restart: always
    ports:
      - "4200:4200"  # Mapiramo port 4200
    volumes:
      - ../score-minds-frontend:/app          # Mapira tvoj kod (Hot Reload)
      - /app/node_modules         # 캛uva node_modules
    
    # 丘멆잺 KLJU캛NO ZA DOCKER: Mora코 dodati --host 0.0.0.0
    # Ako to ne stavi코, Angular se vezuje za localhost unutar kontejnera 
    # i ti ne mo쬰코 da mu pristupi코 iz browsera.
    command: npm start -- --host 0.0.0.0 --poll 2000 
    
    # Opciono: Da frontend krene tek kad API bude spreman
    depends_on:
      - api

# ---------------------------------------------
# GLOBALNI VOLUMENI (Za trajno 캜uvanje podataka)
# ---------------------------------------------
volumes:
  pgdata:
  rabbitmq_data: